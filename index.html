<!DOCTYPE html>
<html lang="en">
  <head>
    <title>PoE Speed Calculator</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!--
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    -->
    <link rel="stylesheet" href="https://bootswatch.com/slate/bootstrap.min.css">
    <link rel="stylesheet" href="https://gitcdn.github.io/bootstrap-toggle/2.2.2/css/bootstrap-toggle.min.css">
    
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <script src="https://gitcdn.github.io/bootstrap-toggle/2.2.2/js/bootstrap-toggle.min.js"></script>
    
    <!--
    <script type="text/javascript" src="https://rawgit.com/naijaro/poe-speed-calculator/master/js/test.js"></script>
    -->
    <style media="screen" type="text/css">
      .hidden {
        display: none;
      }
      .navbar {
        margin-bottom: 10px;
      }
      #main-form {
        margin-top: 5px;
      }
      #result-values {
        position: relative;
      }
      #results-pin {
        display: none;
        position: absolute;
        top: -40px;
        right: 5px;
      }
      
      .result-docked-top #results-pin {
        display: block;
      }
      .result-docked-top #results-block {
        position: fixed;
        top: 0;
        right: 0;
        left: 0;
        z-index: 1031;
        width: 100%;
        background-color: #3a3f44;
        background-image: linear-gradient(#484e55, #3a3f44 60%, #313539);
        border: 1px solid rgba(0,0,0,0.6);
      }
      .result-docked-top #results-block h3 {
        display: none;
      }
      .result-docked-top #result-values {
        max-width: 1070px;
        width: 100%;
        margin: 0 auto;
      }
      .result-docked-top #main-form {
        margin-top: 25px;
      }
      .result-docked-top #results-pin {
        top: auto;
        bottom: -5px;
      }
      
      .btn-info-alt {
        color: #ffffff;
        background-image: -webkit-linear-gradient(#ab74e3, #915bde  60%, #8b4adb);
        background-image: -o-linear-gradient(#ab74e3, #915bde  60%, #8b4adb);
        background-image: -webkit-gradient(linear, left top, left bottom, from(#ab74e3), color-stop(60%, #915bde ), to(#8b4adb));
        background-image: linear-gradient(#ab74e3, #915bde  60%, #8b4adb);
        background-repeat: no-repeat;
        filter: progid:DXImageTransform.Microsoft.gradient(startColorstr='#ffab74e3', endColorstr='#ff8b4adb', GradientType=0);
        -webkit-filter: none;
        filter: none;
      }
      .btn-info-alt:hover {
        background-image: -webkit-linear-gradient(#895cb7, #784bb9  60%, #6b39a9);
        background-image: -o-linear-gradient(#895cb7, #784bb9  60%, #6b39a9);
        background-image: -webkit-gradient(linear, left top, left bottom, from(#895cb7), color-stop(60%, #784bb9 ), to(#6b39a9));
        background-image: linear-gradient(#895cb7, #784bb9  60%, #6b39a9);        
        background-repeat: no-repeat;
        filter: progid:DXImageTransform.Microsoft.gradient(startColorstr='#ff895cb7', endColorstr='#ff6b39a9', GradientType=0);
        -webkit-filter: none;
        filter: none;
      }
      .well {
        padding-bottom: 0;
      }
      .panel .toggle.btn {
        width: 100%;
        margin-bottom: 5px;
      }
      .panel .toggle.btn label {
        text-align: left;
      }
      .panel .effect-checkbox {
        width: 100%;
      }
      .panel .panel-heading {
        position: relative;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      .panel .panel-heading .badge {
        float: right;
        border-radius: 50%;
        position: absolute;
        right: 7px;
        top: 11px;
      }
      .panel > .panel-heading .badge-info {
        background-color: #5bc0de;
      }
      .panel > .panel-heading .badge-info-alt {
        background-color: #915bde ;
      }
      
      #weapons-row .weapon-col {
        float: none;
        display: inline-block;

        -webkit-transition: width 500ms;
                transition: width 500ms;
      }
      #weapons-row.inline {
        white-space: nowrap;
      }      
      #weapons-row.two-handed .weapon-col {
        width: 100%;
      }
      .weapon-col.abs-right {
        position: absolute;
        right: 0;
      }      
      .toggle.suppressed .toggle-on {
        background-image: linear-gradient(#a6a6a7, #79797d 60%, #707171);
      }
      .toggle.suppressed .toggle-on:hover {        
        background-image: linear-gradient(#8d8d8e, #5d5d5f 60%, #565656);
      }      
      .progress-bar.oh-attack {
        opacity: 0.8;
      }
      
      @media all and (max-width: 767px) {
        #page-title {
          text-align: center;
          font-size: 32px;
        }
        #page-info {
          text-align: center;
          margin-bottom: 20px;
        }
        .block-title {
          text-align: center;
          margin: 0 0 20px;
        }
        #results-pin {
          display: block;
        }
      }   
    </style>
  </head>
  <body>
    <div class="navbar navbar-default">
      <div class="container">
        <div class="navbar-header">
          <span class="navbar-brand">Pillars of Eternity</span>
        </div>
      </div>
    </div>
    <div class="container">
      <h1 id="page-title">Speed Calculator</h1>
      <p id="page-info">version 0.6 (Alpha) <a class="text-muted" href="https://forums.obsidian.net/user/160416-maxquest/">by MaxQuest</a></p>     
      <form class="form-horizontal" id="main-form">
        <div class="row">
          <div class="col-lg-6 col-md-6 col-xs-12" id="equipment-block">
            <h3 class="block-title">Equipment</h3>
            <div class="well">
              <div class="row">
                <div class="col-lg-6 col-sm-6 col-xs-12" id="armor-col">
                  <div class="panel panel-default">
                    <div class="panel-heading">Armor Type (TODO)</div>
                    <div class="panel-body">
                      <select class="form-control">
                        <option value="0">Naked</option>
                        <option value="0">Cloth</option>
                        <option value="0.15">Robe</option>
                        <option value="0.20">Padded</option>
                        <option value="0.25">Hide</option>
                        <option value="0.30">Leather</option>
                        <option value="0.35">Scale</option>
                        <option value="0.40">Breastplate</option>
                        <option value="0.45">Mail</option>
                        <option value="0.50">Brigandine</option>
                        <option value="0.50">Plate</option>
                      </select>
                      <div class="checkbox">
                        <label><input type="checkbox" class="property" data-prop="durganized"> Is Durganized</label>
                      </div>
                      <div class="checkbox">
                        <label><input type="checkbox" class="property" data-prop="armored_grace"> Armored Grace</label>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="col-lg-6 col-sm-6 col-xs-12" id="gloves-col">
                  <div class="panel panel-default">
                    <div class="panel-heading">Gloves (TODO)</div>
                    <div class="panel-body">
                      <select class="form-control">
                        <option>Other</option>
                        <option>Gauntlets of Swift Action</option>
                        <option>Mourning Gloves</option>
                        <option>Pilferer's Grip</option>
                      </select>
                      <div style="min-height: 29px;">&nbsp;</div>
                    </div>
                  </div>
                </div>
              </div>
              <div class="row" id="weapons-row" style="position: relative; overflow: hidden;">
                <div class="col-lg-6 col-sm-6 col-xs-12 weapon-col" id="mainhand-col">
                  <div class="panel panel-default">
                    <div class="panel-heading">Mainhand</div>
                    <div class="panel-body">
                      <select class="form-control" id="mainhand-select"></select>
                      <div class="checkbox">
                        <label><input type="checkbox" class="property" data-prop="durganized"> Is Durganized</label>
                      </div>
                      <div class="checkbox">
                        <label><input type="checkbox" class="property" data-prop="speed"> Has Speed <span class="text-muted">(enchant)</span></label>
                      </div>
                    </div>
                  </div>
                </div
               ><div class="col-lg-6 col-sm-6 col-xs-12 weapon-col" id="offhand-col">
                  <div class="panel panel-default">
                    <div class="panel-heading">Offhand</div>
                    <div class="panel-body">
                      <select class="form-control" id="offhand-select"></select>
                      <div class="checkbox">
                        <label><input type="checkbox" class="property" data-prop="durganized"> Is Durganized</label>
                      </div>
                      <div class="checkbox">
                        <label><input type="checkbox" class="property" data-prop="speed"> Has Speed <span class="text-muted">(enchant)</span></label>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              <div class="clearfix"></div>
            </div>
          </div>
          <div class="col-lg-6 col-md-6 col-xs-12" id="effects-block" style="float: right;">
            <h3 class="block-title">Buffs & Effects</h3>
            <div class="well">        
              <div class="row">
                <div class="col-lg-6 col-sm-6 col-xs-12">
                  <div class="panel panel-default panel-effects" data-id="AttackSpeedMult">
                    <div class="panel-heading">AttackSpeedMult <span class="badge badge-info">&nbsp;</span></div>
                    <div class="panel-body"></div>
                  </div>
                </div>
                <div class="col-lg-6 col-sm-6 col-xs-12">
                  <div class="panel panel-default panel-effects" data-id="MeleeAttackSpeedMult">
                    <div class="panel-heading">MeleeAttackSpeedMult <span class="badge badge-info">&nbsp;</span></div>
                    <div class="panel-body"></div>
                  </div>
                  <div class="panel panel-default panel-effects" data-id="RangedAttackSpeedMult">
                    <div class="panel-heading">RangedAttackSpeedMult <span class="badge badge-info">&nbsp;</span></div>
                    <div class="panel-body"></div>
                  </div>
                  <div class="panel panel-default panel-effects" data-id="RateOfFireMult">
                    <div class="panel-heading">RateOfFireMult <span class="badge badge-info">&nbsp;</span></div>
                    <div class="panel-body"></div>
                  </div>
                  <div class="panel panel-default panel-effects" data-id="ReloadSpeedCoef">
                    <div class="panel-heading">ReloadSpeedCoef <span class="badge badge-info-alt">&nbsp;</span></div>
                    <div class="panel-body"></div>
                  </div>
                </div>
              </div>
            </div>  
          </div>          
          <div class="col-lg-6 col-md-6 col-xs-12" id="results-block">            
            <h3 class="block-title">Result</h3>
            <div id="result-values">
              <i class="glyphicon glyphicon-pushpin" id="results-pin"></i>
              <blockquote style="padding-right: 0;" id="base-results-block">
                <div class="progress">
                  <div class="progress-bar                      mh-delay"  style="width: 4%" title="Delay (4-5 frames)"></div>
                  <div class="progress-bar progress-bar-success mh-attack" style="width: 25%" title="Attack duration"></div>
                  <div class="progress-bar progress-bar-warning mh-recovery" style="width: 41.6667%;" title="Recovery duration"></div>
                  <div class="progress-bar progress-bar-danger  mh-reload" style="width: 0%" title="Reload duration"></div>
                  <div class="progress-bar progress-bar-success oh-attack hidden" style="width: 0%" title="Attack duration"></div>
                  <div class="progress-bar progress-bar-warning oh-recovery hidden" style="width: 0%;" title="Recovery duration"></div>
                </div>
                <small>Base values (at 10 DEX): 
                  <cite title="Speed">
                    <span class="mh-attack-result">attack: <span class="value">30f</span></span><span 
                          class="mh-recovery-result">, recovery: <span class="value">50f</span></span><span 
                          class="mh-reload-result hidden">, reload: <span class="value">150f</span></span><span 
                          class="oh-attack-result hidden">, attack: <span class="value">30f</span></span><span 
                          class="oh-recovery-result hidden">, recovery: <span class="value">50f</span></span>
                  </cite>
                </small>
              </blockquote>
              <blockquote style="padding-right: 0;" id="final-results-block">
                <div class="progress">
                  <div class="progress-bar                      mh-delay"  style="width: 4%" title="Delay (4-5 frames)"></div>
                  <div class="progress-bar progress-bar-success mh-attack" style="width: 25%" title="Attack duration"></div>
                  <div class="progress-bar progress-bar-warning mh-recovery" style="width: 41.6667%;" title="Recovery duration"></div>
                  <div class="progress-bar progress-bar-danger  mh-reload" style="width: 0%" title="Reload duration"></div>
                  <div class="progress-bar progress-bar-success oh-attack hidden" style="width: 0%" title="Attack duration"></div>
                  <div class="progress-bar progress-bar-warning oh-recovery hidden" style="width: 0%;" title="Recovery duration"></div>
                </div>
                <small>Final values (TODO): 
                  <cite title="Speed">
                    <span class="mh-attack-result">attack: <span class="value">30f</span></span><span 
                          class="mh-recovery-result">, recovery: <span class="value">50f</span></span><span 
                          class="mh-reload-result hidden">, reload: <span class="value">150f</span></span><span 
                          class="oh-attack-result hidden">, attack: <span class="value">30f</span></span><span 
                          class="oh-recovery-result hidden">, recovery: <span class="value">50f</span></span>
                  </cite>
                </small>
              </blockquote>
            </div>
          </div>  
        </div>
      </form>
    </div>
    <script>
    (function($, undefined) {

      var VARS = {};
      var ATTACK_DURATION_XS = 19.09;
      var ATTACK_DURATION_SM = 20;
      var ATTACK_DURATION_MD = 30;
      var ATTACK_DURATION_LG = 45;

      var SHIELD_ID = 200;
      var BASHING_SHIELD_ID = 201;

      var WIELDABLE_CATEGORIES = {
        oneHanded: 'One-Handed',
        twoHandedMelee: 'Two-Handed Melee',
        twoHandedRanged: 'Two-Handed Ranged',
        shields: 'Shields'
      };
            
      var WIELDABLES = [
        GenWieldable(WIELDABLE_CATEGORIES.oneHanded, ATTACK_DURATION_MD, "Battle Axe"),
        GenWieldable(WIELDABLE_CATEGORIES.oneHanded, ATTACK_DURATION_SM, "Club"),
        GenWieldable(WIELDABLE_CATEGORIES.oneHanded, ATTACK_DURATION_SM, "Dagger"),
        GenWieldable(WIELDABLE_CATEGORIES.oneHanded, ATTACK_DURATION_SM, "Flail"),
        GenWieldable(WIELDABLE_CATEGORIES.oneHanded, ATTACK_DURATION_SM, "Hatchet"),
        GenWieldable(WIELDABLE_CATEGORIES.oneHanded, ATTACK_DURATION_SM, "Mace"),
        GenWieldable(WIELDABLE_CATEGORIES.oneHanded, ATTACK_DURATION_XS, "Rapier"),
        GenWieldable(WIELDABLE_CATEGORIES.oneHanded, ATTACK_DURATION_MD, "Sabre"),
        GenWieldable(WIELDABLE_CATEGORIES.oneHanded, ATTACK_DURATION_SM, "Spear"),
        GenWieldable(WIELDABLE_CATEGORIES.oneHanded, ATTACK_DURATION_XS, "Stiletto"),
        GenWieldable(WIELDABLE_CATEGORIES.oneHanded, ATTACK_DURATION_MD, "Sword"),
        GenWieldable(WIELDABLE_CATEGORIES.oneHanded, ATTACK_DURATION_MD, "War Hammer"),
        
        GenWieldable(WIELDABLE_CATEGORIES.twoHandedMelee, ATTACK_DURATION_MD, "Estoc"),
        GenWieldable(WIELDABLE_CATEGORIES.twoHandedMelee, ATTACK_DURATION_MD, "Great Sword"),
        GenWieldable(WIELDABLE_CATEGORIES.twoHandedMelee, ATTACK_DURATION_MD, "Morning Star"),
        GenWieldable(WIELDABLE_CATEGORIES.twoHandedMelee, ATTACK_DURATION_MD, "Pike"),
        GenWieldable(WIELDABLE_CATEGORIES.twoHandedMelee, ATTACK_DURATION_MD, "Pollaxe"),
        GenWieldable(WIELDABLE_CATEGORIES.twoHandedMelee, ATTACK_DURATION_MD, "Quarterstaff"),
        
        GenWieldable(WIELDABLE_CATEGORIES.twoHandedRanged, ATTACK_DURATION_LG, "Arbalest", 180),
        GenWieldable(WIELDABLE_CATEGORIES.twoHandedRanged, ATTACK_DURATION_LG, "Arquebus", 204),
        GenWieldable(WIELDABLE_CATEGORIES.twoHandedRanged, ATTACK_DURATION_LG, "Blunderbuss", 150),
        GenWieldable(WIELDABLE_CATEGORIES.twoHandedRanged, ATTACK_DURATION_LG, "Crossbow", 100),
        GenWieldable(WIELDABLE_CATEGORIES.twoHandedRanged, ATTACK_DURATION_MD, "Hunting Bow"),
        GenWieldable(WIELDABLE_CATEGORIES.twoHandedRanged, ATTACK_DURATION_LG, "Pistol", 150),
        GenWieldable(WIELDABLE_CATEGORIES.twoHandedRanged, ATTACK_DURATION_LG, "Rod"),
        GenWieldable(WIELDABLE_CATEGORIES.twoHandedRanged, ATTACK_DURATION_MD, "Sceptre"),
        GenWieldable(WIELDABLE_CATEGORIES.twoHandedRanged, ATTACK_DURATION_MD, "Wand"),
        GenWieldable(WIELDABLE_CATEGORIES.twoHandedRanged, ATTACK_DURATION_LG, "War Bow"),
        
        GenWieldable(WIELDABLE_CATEGORIES.shields, null, "Shield", null, SHIELD_ID),
        GenWieldable(WIELDABLE_CATEGORIES.shields, ATTACK_DURATION_SM, "Shield with Bash", null, BASHING_SHIELD_ID)
      ];
      
      var $MAINHAND_SELECT;
      var $OFFHAND_SELECT;
      var $WEAPONS_ROW;
      
      var MH_WIELDABLE = GetWieldableById(1);
      var OH_WIELDABLE = GetWieldableById(SHIELD_ID);
      
      var IS_2H_SETUP;
      var IS_DW_SETUP;
      var IS_OFFHAND_ATTACKING;
      
      var EFFECT_CATEGORIES = {
        attackSpeedMult: 'AttackSpeedMult',
        meleeAttackSpeedMult: 'MeleeAttackSpeedMult',
        rangedAttackSpeedMult: 'RangedAttackSpeedMult',
        rateOfFireMult: 'RateOfFireMult',
        reloadSpeedCoef: 'ReloadSpeedCoef'
      };
      
      var SUPPRESING_CATEGORIES = {
        attackSpeedMult1: 'AttackSpeedMult1',
        reloadSpeedCoef1: 'ReloadSpeedCoef1'
      };
      
     var EFFECT_COEFFICIENTS = {
        melee: {},
        ranged: {}
      };
      
      var EFFECTS = [
        GenEffect(EFFECT_CATEGORIES.attackSpeedMult, 1.10, "Anitlei (Zahua passive)"),
        GenEffect(EFFECT_CATEGORIES.attackSpeedMult, 1.20, "Bloodlust"),
        GenEffect(EFFECT_CATEGORIES.attackSpeedMult, 0.80, "Cautious Attack"),
        GenEffect(EFFECT_CATEGORIES.attackSpeedMult, 1.50, "DAoM Potion", SUPPRESING_CATEGORIES.attackSpeedMult1),
        GenEffect(EFFECT_CATEGORIES.attackSpeedMult, 1.33, "Frenzy", SUPPRESING_CATEGORIES.attackSpeedMult1),
        // GenEffect(EFFECT_CATEGORIES.attackSpeedMult, 1.25, "Hastening Exhortation", SUPPRESING_CATEGORIES.attackSpeedMult1),
        GenEffect(EFFECT_CATEGORIES.attackSpeedMult, 1.20, "Nature's Bounty", SUPPRESING_CATEGORIES.attackSpeedMult1),
        GenEffect(EFFECT_CATEGORIES.attackSpeedMult, 1.25, "Outlander's Frenzy", SUPPRESING_CATEGORIES.attackSpeedMult1),
        GenEffect(EFFECT_CATEGORIES.attackSpeedMult, 1.25, "Potion of Power", SUPPRESING_CATEGORIES.attackSpeedMult1),
        GenEffect(EFFECT_CATEGORIES.attackSpeedMult, 1.15, "Svef", SUPPRESING_CATEGORIES.attackSpeedMult1),
        GenEffect(EFFECT_CATEGORIES.attackSpeedMult, 1.20, "Swift Aim", SUPPRESING_CATEGORIES.attackSpeedMult1),
        GenEffect(EFFECT_CATEGORIES.attackSpeedMult, 1.20, "Swift Strikes", SUPPRESING_CATEGORIES.attackSpeedMult1),
        GenEffect(EFFECT_CATEGORIES.attackSpeedMult, 1.40, "Their Champion Chant", SUPPRESING_CATEGORIES.attackSpeedMult1),
        GenEffect(EFFECT_CATEGORIES.attackSpeedMult, 1.50, "Time Parasite", SUPPRESING_CATEGORIES.attackSpeedMult1),
        GenEffect(EFFECT_CATEGORIES.attackSpeedMult, 1.20, "Vielo Vidorio", SUPPRESING_CATEGORIES.attackSpeedMult1),
        
        GenEffect(EFFECT_CATEGORIES.meleeAttackSpeedMult, 0.80, "Vulnerable Attack"),        
        GenEffect(EFFECT_CATEGORIES.rangedAttackSpeedMult, 0.80, "Penetrating Shot"),        
        GenEffect(EFFECT_CATEGORIES.rateOfFireMult, 1.20, "Sure-Handed Chant"),
        GenEffect(EFFECT_CATEGORIES.rateOfFireMult, 0.80, "Vicious Aim"),
        
        GenEffect(EFFECT_CATEGORIES.reloadSpeedCoef, 1.20, "Gunner"),
        GenEffect(EFFECT_CATEGORIES.reloadSpeedCoef, 1.20, "Sure-Handed Chant", SUPPRESING_CATEGORIES.reloadSpeedCoef1),
        GenEffect(EFFECT_CATEGORIES.reloadSpeedCoef, 1.50, "Swift Aim", SUPPRESING_CATEGORIES.reloadSpeedCoef1),
        GenEffect(EFFECT_CATEGORIES.reloadSpeedCoef, 0.80, "Vicious Aim")
      ];
      
      var ENABLED_EFFECTS = {};
      
      function Init()
      {
        document.readyState === "complete" ? InitOnReady()
                                           : $(document).ready(function(){InitOnReady();});
      }

      function InitOnReady()
      {
        $MAINHAND_SELECT = $('#mainhand-select');
        $OFFHAND_SELECT = $('#offhand-select');
        $WEAPONS_ROW = $('#weapons-row');
        
        PopulateWeaponSelects();
        PopulateEffects();
        BindEvents();
        
        UpdateEffectCoefficients();
        UpdateResults(); 
      }

      function BindEvents()
      {
        $('#results-pin').on('click', function() {
          $('body').toggleClass('result-docked-top');
        });
        
        $MAINHAND_SELECT.on('change', function() {
          OnMainhandChange(this.value);
        });
        
        $OFFHAND_SELECT.on('change', function() {
          OnOffhandChange(this.value);
        });
        
        $('.armor-col select').on('change', function() {
          // TODO OnArmorChange
          UpdateResults();
        });
        
        $('#equipment-block .property[type="checkbox"]').on('change', function() {
          console.log('checkbox toggle');
          UpdateResults();
        });
        
        $('.panel-effects .effect-checkbox').change(function() {
          var $checkbox = $(this);
          var isChecked = $checkbox.prop('checked');
          var effect = GetEffectById($checkbox.data('id'));
          
          if (isChecked)
            ENABLED_EFFECTS[effect.id] = effect;
          else
            delete ENABLED_EFFECTS[effect.id];
          
          if (effect.suppressingCategory)
            UpdateSuppression();
                    
          UpdateEffectCoefficients();
          UpdateResults(); 
        });
      }
      
      /* ****************************** EVENTS ****************************** */

      function OnMainhandChange(wieldableId)
      {
        MH_WIELDABLE = GetWieldableById(wieldableId);
        
        UpdateSetupConfig();
        UpdateResults(); 
      }
      
      function OnOffhandChange(wieldableId)
      {
        OH_WIELDABLE = GetWieldableById(wieldableId);
        
        UpdateSetupConfig();
        UpdateResults();        
      }
            
      /* ****************************** GETTERS ***************************** */

      function GenWieldable(category, attackDuration, title, reloadDuration, forcedId)
      {
        VARS.WIELDABLE_ID = forcedId || VARS.WIELDABLE_ID || 1;
        return {
          id: VARS.WIELDABLE_ID++,
          title: title,
          category: category,
          attackDuration: attackDuration,
          reloadDuration: reloadDuration || null
        };
      }

      function GetWieldableById(id)
      {
        for (var i in WIELDABLES)
          if (WIELDABLES[i].id == id)
            return WIELDABLES[i];
        
        return null;
      }
      
      function GenEffect(category, value, title, suppressingCategory, forcedId)
      {
        VARS.EFFECT_ID = forcedId || VARS.EFFECT_ID || 1;
        return {
          id: VARS.EFFECT_ID++,
          title: title,
          value: value,
          category: category,          
          suppressingCategory: suppressingCategory || null,
          suppressed: false
        };
      }
      
      function GetEffectById(id)
      {
        for (var i in EFFECTS)
          if (EFFECTS[i].id == id)
            return EFFECTS[i];
        
        return null;
      }
      
      function GetEnabledEffectsCoefficients(category)
      {
        var coefficients = [];
        var effect = null;
        
        for (var i in ENABLED_EFFECTS)
        {
          effect = ENABLED_EFFECTS[i];
          
          if (effect.category == category && effect.suppressed == false)
            coefficients.push(effect.value);
        }
        
        return coefficients;
      }
      
      function GetBaseResultsBlock()
      {
        if (VARS.$BASE_RESULTS_BLOCK == null)
          VARS.$BASE_RESULTS_BLOCK = $('#base-results-block');
        
        return VARS.$BASE_RESULTS_BLOCK;
      }
      
      function GetFinalResultsBlock()
      {
        if (VARS.$FINAL_RESULTS_BLOCK == null)
          VARS.$FINAL_RESULTS_BLOCK = $('#final-results-block');
        
        return VARS.$FINAL_RESULTS_BLOCK;
      }
      
      /* ****************************** ACTIONS ***************************** */

      function PopulateWeaponSelects()
      {
        PopulateMainhandSelect();
        PopulateOffhandSelect();
      }
      
      function PopulateMainhandSelect()
      {
        var categories = [
          WIELDABLE_CATEGORIES.oneHanded, 
          WIELDABLE_CATEGORIES.twoHandedMelee, 
          WIELDABLE_CATEGORIES.twoHandedRanged
        ];
        
        PopulateWieldableSelect($MAINHAND_SELECT, categories, WIELDABLES);       
      }
      
      function PopulateOffhandSelect()
      {
        var categories = [
          WIELDABLE_CATEGORIES.shields,
          WIELDABLE_CATEGORIES.oneHanded
        ]; 
        PopulateWieldableSelect($OFFHAND_SELECT, categories, WIELDABLES); 
      }
      
      function PopulateEffects()
      {
        PopulateEffectsPanel(EFFECT_CATEGORIES.attackSpeedMult);
        PopulateEffectsPanel(EFFECT_CATEGORIES.meleeAttackSpeedMult);
        PopulateEffectsPanel(EFFECT_CATEGORIES.rangedAttackSpeedMult);
        PopulateEffectsPanel(EFFECT_CATEGORIES.rateOfFireMult);
        PopulateEffectsPanel(EFFECT_CATEGORIES.reloadSpeedCoef, 'info-alt');
      }
      
      function PopulateEffectsPanel(category, style)
      {
        var $panel = $('.panel-effects[data-id="' + category + '"]');
        var style = style || 'info';
        var effectsHtml = '';
        
        for (var i in EFFECTS)
        {
          var effect = EFFECTS[i];
          
          if (effect.category == category)
            effectsHtml+= 
              '<input class="effect-checkbox" type="checkbox" ' + 
                     'data-id="' + effect.id + '"' +
                     'data-toggle="toggle" ' + 
                     'data-on="' + effect.title + '" ' + 
                     'data-off="' + effect.title + '" ' + 
                     'data-onstyle="' + style + '" ' + 
                     'data-width="100%"/>';
        }
        $panel.find('.panel-body').html(effectsHtml);
        $panel.find('.panel-body input').bootstrapToggle();
      }
      
      function PopulateWieldableSelect($select, categories, vars)
      {
        for (var i in categories)
        {
          var category = categories[i];
          var $optgroup = $('<optgroup/>').attr('label', category);
          
          for (var k in vars)
          {
            var item = vars[k];
            
            if (item.category !== category)
              continue;
            
            $('<option />').html(item.title).attr('value', item.id).appendTo($optgroup);
          }
          $optgroup.appendTo($select);
        } 
      }
      
      function PopulateBaseResults(data) 
      {
        PopulateResults(data, GetBaseResultsBlock());
      }
      
      function PopulateFinalResults(data) 
      {
        PopulateResults(data, GetFinalResultsBlock());
      }
      
      function PopulateResults(data, $block) 
      {
        if (!data || !$block)
          return;
        
        var delay = 5;
        var maxDuration = ATTACK_DURATION_LG * 16 / 6 + delay;
        
        var mhAttack= data.mh && data.mh.attack ? data.mh.attack : 0;
        var mhRecovery = data.mh && data.mh.recovery ? data.mh.recovery : 0;
        var mhReload = data.mh && data.mh.reload ? data.mh.reload : 0;
        
        if (mhReload > 0)
          maxDuration+= 250;
        
        var ohAttack = data.oh && data.oh.attack ? data.oh.attack : 0;
        var ohRecovery = data.oh && data.oh.recovery ? data.oh.recovery : 0;
        
        $block.find('.mh-delay').width(GetPercStr(delay / maxDuration));
        $block.find('.mh-attack').width(GetPercStr(mhAttack / maxDuration));
        $block.find('.mh-recovery').width(GetPercStr(mhRecovery / maxDuration));
        $block.find('.mh-reload').width(GetPercStr(mhReload / maxDuration));
        
        $block.find('.oh-attack').width(GetPercStr(ohAttack / maxDuration));
        $block.find('.oh-recovery').width(GetPercStr(ohRecovery / maxDuration));
        
        $block.find('.mh-attack-result .value').html(GetRoundedValue(mhAttack));
        $block.find('.mh-recovery-result .value').html(GetRoundedValue(mhRecovery));
        $block.find('.mh-reload-result .value').html(GetRoundedValue(mhReload));
        $block.find('.oh-attack-result .value').html(GetRoundedValue(ohAttack));
        $block.find('.oh-recovery-result .value').html(GetRoundedValue(ohRecovery));
        
        $block.find('.mh-reload-result').toggleClass('hidden', mhReload <= 0);
        $block.find('.oh-attack-result').toggleClass('hidden', !IS_OFFHAND_ATTACKING);
        $block.find('.oh-recovery-result').toggleClass('hidden', !IS_OFFHAND_ATTACKING);
        
        $block.find('.progress').animate({ opacity: 0.5 }, 300)
                                .animate({ opacity: 1.0 }, 300);
      }
      
      function UpdateSetupConfig() 
      {
        var was2H = IS_2H_SETUP;
        
        IS_2H_SETUP = MH_WIELDABLE.category == WIELDABLE_CATEGORIES.twoHandedMelee ||
                      MH_WIELDABLE.category == WIELDABLE_CATEGORIES.twoHandedRanged;
        
        IS_DW_SETUP = MH_WIELDABLE.category == WIELDABLE_CATEGORIES.oneHanded &&
                      OH_WIELDABLE.category == WIELDABLE_CATEGORIES.oneHanded &&
                     !IS_2H_SETUP;
        
        IS_OFFHAND_ATTACKING = (OH_WIELDABLE.category == WIELDABLE_CATEGORIES.oneHanded ||
                                OH_WIELDABLE.id == BASHING_SHIELD_ID) && !IS_2H_SETUP;
                
        if (!was2H && IS_2H_SETUP)
          $WEAPONS_ROW.addClass('two-handed inline');
        
        if (was2H && !IS_2H_SETUP)
        {
          $WEAPONS_ROW.removeClass('two-handed');
          setTimeout(function(){ $WEAPONS_ROW.removeClass('inline'); }, 500);
        }
        
        var $block = $('#results-block');
        $block.find('.oh-attack').toggleClass('hidden', !IS_OFFHAND_ATTACKING);
        $block.find('.oh-recovery').toggleClass('hidden', !IS_OFFHAND_ATTACKING);
      }
      
      function UpdateSuppression()
      {
        var $effectsBlock = $('#effects-block');
        
        for (var i in SUPPRESING_CATEGORIES)
        {
          var suppressingCategory = SUPPRESING_CATEGORIES[i];
          var unsuppresedEffect = null;
          
          for (var j in ENABLED_EFFECTS)
          {
            var effect = ENABLED_EFFECTS[j];
            
            if (effect.suppressingCategory == suppressingCategory)
            {
              if (unsuppresedEffect == null ||
                 (effect.value > 1 && effect.value > unsuppresedEffect.value) ||
                 (effect.value < 1 && effect.value < unsuppresedEffect.value))
                unsuppresedEffect = effect;
            }
          }
          
          for (var j in ENABLED_EFFECTS)
          {
            var effect = ENABLED_EFFECTS[j];            
            if (effect.suppressingCategory != suppressingCategory)
              continue;               
            
            var $checkbox = $effectsBlock.find('.effect-checkbox[data-id="' + effect.id + '"]');
            var $toggle = $checkbox.parent();
            var isSuppressed = effect.id != unsuppresedEffect.id;
            var title = isSuppressed ? 'Suppressed by ' + unsuppresedEffect.title : '';
            
            ENABLED_EFFECTS[j].suppressed = isSuppressed;
            $toggle.toggleClass('suppressed', isSuppressed);
            $toggle.prop('title', title);
          }
        }
      }
      
      function UpdateEffectCoefficients()
      {
        var meleeCategories = [
          EFFECT_CATEGORIES.attackSpeedMult,
          EFFECT_CATEGORIES.meleeAttackSpeedMult
        ];
        
        var rangedCategories = [
          EFFECT_CATEGORIES.attackSpeedMult,
          EFFECT_CATEGORIES.rangedAttackSpeedMult,
          EFFECT_CATEGORIES.rateOfFireMult,
          EFFECT_CATEGORIES.reloadSpeedCoef
        ];
        
        UpdateEffectCoefficientsByRange('melee', meleeCategories);
        UpdateEffectCoefficientsByRange('ranged', rangedCategories);
      }
      
      function UpdateEffectCoefficientsByRange(range, categories)
      {
        for (var i in categories)
          EFFECT_COEFFICIENTS[range][categories[i]] = MultArrayValues(GetEnabledEffectsCoefficients(categories[i]));        
      }
      
      function UpdateResults()
      {
        PopulateBaseResults(ComputeBaseValues());
        PopulateFinalResults(ComputeFinalValues());
      }
      
      /* ******************************************************************** */
      
      function ComputeBaseValues()
      {
        var values = [];
        
        if (MH_WIELDABLE != null)
        {
          var mhRecovery = Math.round(100 * MH_WIELDABLE.attackDuration / 0.6) / 100;
              mhRecovery/= IS_DW_SETUP ? 2 : 1; 
          
          values.mh = {
            attack: MH_WIELDABLE.attackDuration,
            recovery: mhRecovery,
            reload: MH_WIELDABLE.reloadDuration
          };
        }
        
        if (IS_OFFHAND_ATTACKING)
        {
          var ohRecovery = Math.round(100 * OH_WIELDABLE.attackDuration / 0.6 / 2) / 100;
          
          values.oh = {
            attack: OH_WIELDABLE.attackDuration,
            recovery: ohRecovery,
            reload: null
          };
        }
        
        return values;
      }
      
      function ComputeFinalValues()
      {
        var values = ComputeBaseValues();
        var cats = EFFECT_CATEGORIES;
        var coefs = IsWieldableRanged(MH_WIELDABLE) ? EFFECT_COEFFICIENTS.ranged
                                                    : EFFECT_COEFFICIENTS.melee;
                                                    
        if (values.mh && values.mh.reload && coefs[cats.reloadSpeedCoef])
          values.mh.reload/= coefs[cats.reloadSpeedCoef];
        
        var speedCoefMH = ComputeMainhandSpeedCoef();
        var speedCoefOH = ComputeOffhandSpeedCoef();               
        
        var recoveryCoefMH = Math.max(0, 1 - 2 * speedCoefMH) / 1.2;
        var recoveryCoefOH = Math.max(0, 1 - 2 * speedCoefOH) / 1.2;
        
        console.log('speedCoefMH', speedCoefMH);
        console.log('speedCoefOH', speedCoefOH);
        console.log('recoveryCoefMH', recoveryCoefMH);
        console.log('recoveryCoefOH', recoveryCoefOH);
        
        if (values.mh && values.mh.attack)
          values.mh.recovery = values.mh.attack * recoveryCoefMH; 
        
        if (values.oh && values.oh.attack)
          values.oh.recovery = values.oh.attack * recoveryCoefOH; 
        
        console.log('values', values);
        
        return values;
      }
      
      function ComputeMainhandSpeedCoef()
      {
        if (MH_WIELDABLE == null)
          return 0;
        
        var speedCoef = 0;
        var cats = EFFECT_CATEGORIES;
        var coefs = IsWieldableRanged(MH_WIELDABLE) ? EFFECT_COEFFICIENTS.ranged
                                                    : EFFECT_COEFFICIENTS.melee;
        var coefficients = jQuery.extend(true, {}, coefs);
        
        var $container = $('#mainhand-col');
        var isDurganized = $container.find('.property[data-prop="durganized"]').is(':checked');
        var hasSpeed = $container.find('.property[data-prop="speed"]').is(':checked');
        
        for (var category in coefficients)
        {
          if (!IsMultiplicativeRecoveryCategory(category))
            continue;
          
          var coef = coefficients[category];

          if (category == cats.attackSpeedMult && isDurganized)
            coef*= 1.15;

          if (category == cats.attackSpeedMult && hasSpeed)
            coef*= 1.20;

          speedCoef+= coef - 1;          
        }
        
        if (!IS_DW_SETUP)
        {
          speedCoef-= HasDurganizedShieldInOffhand() ? 0.35 : 0.5;
        }
        
        return speedCoef;
      }
      
      function ComputeOffhandSpeedCoef()
      {
        if (OH_WIELDABLE == null)
          return 0;
        
        var speedCoef = 0;
        var cats = EFFECT_CATEGORIES;
        var coefs = IsWieldableRanged(OH_WIELDABLE) ? EFFECT_COEFFICIENTS.ranged
                                                    : EFFECT_COEFFICIENTS.melee;
        var coefficients = jQuery.extend(true, {}, coefs);
        
        var $container = $('#offhand-col');
        var isDurganized = $container.find('.property[data-prop="durganized"]').is(':checked');
        var hasSpeed = $container.find('.property[data-prop="speed"]').is(':checked');
        
        for (var category in coefficients)
        {
          if (!IsMultiplicativeRecoveryCategory(category))
            continue;
          
          var coef = coefficients[category];

          if (category == cats.attackSpeedMult && isDurganized && OH_WIELDABLE.category != WIELDABLE_CATEGORIES.shields)
            coef*= 1.15;

          if (category == cats.attackSpeedMult && hasSpeed && OH_WIELDABLE != WIELDABLE_CATEGORIES.shields)
            coef*= 1.20;

          speedCoef+= coef - 1;          
        }
                
        return speedCoef;
      }
      
      /* ****************************** UTILS ******************************* */
      
      function IsWieldableRanged(wieldable)
      {
        return wieldable != null && wieldable.category == WIELDABLE_CATEGORIES.twoHandedRanged;
      }
      
      function IsMultiplicativeRecoveryCategory(category)
      {
        return $.inArray(category, [
          EFFECT_CATEGORIES.attackSpeedMult,
          EFFECT_CATEGORIES.meleeAttackSpeedMult,
          EFFECT_CATEGORIES.rangedAttackSpeedMult,
          EFFECT_CATEGORIES.rateOfFireMult
        ]) >= 0;
      }
      
      function HasDurganizedShieldInOffhand()
      {
        if (OH_WIELDABLE == null || OH_WIELDABLE.category != WIELDABLE_CATEGORIES.shields)
          return false;

        return $('#offhand-col .property[data-prop="durganized"]').is(':checked');
      }
      
      function GetPercStr(floatVal)
      {
        return (floatVal * 100) + '%';
      }
      
      function GetRoundedValue(floatVal)
      {
        return Math.round(floatVal * 100) / 100;
      }
      
      function AddArrayValues(arr)
      {
        var foo = 0;
        
        for (var i in arr)
          foo+= arr[i];
        
        return foo;
      }
      
      function MultArrayValues(arr)
      {
        var foo = 1;
        
        for (var i in arr)
          foo*= arr[i];
        
        return foo;
      }
      
      /* ******************************************************************** */

      Init();

      /* ******************************************************************** */

    })(jQuery);
    </script>  
  </body>
</html>